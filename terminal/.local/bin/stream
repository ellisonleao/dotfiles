#!/bin/bash
cmd_exists() {
    command -v "$1" &>/dev/null
    return $?
}

if ! cmd_exists "http"; then
    echo "httpie missing"
    exit 1
fi

if ! cmd_exists "twurl"; then
    echo "twurl missing"
    exit 1
fi

topic="$*"
if [[ ${#topic} -gt 80 ]]; then
    echo "topic must be under 80 chars"
    exit 1
fi

# update twitch stream title
function update_twitch() {
    http PATCH "https://api.twitch.tv/helix/channels?broadcaster_id=${TWITCH_USERID}" \
        "Accept:application/vnd.twitchtv.v5+json" \
        "Client-Id:$TWITCH_CLIENTID" \
        "Authorization:Bearer $TWITCH_APP_OAUTH_TOKEN" \
        title="${topic}" > /dev/null
}

# send tweet with stream title and some hashtags
function update_twitter() {
    twurl -d 'status='"$topic"' twitch.tv/npxbr #neovim #lua #golang #twitch' \
        /1.1/statuses/update.json > /dev/null
}

update_twitter
update_twitch
